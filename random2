
## Clarification on Outcome Distribution Chart

The data label on top of each stacked bar shows the **total number of instances that started that month** (sum of all outcome categories). It includes all outcomes: still_open, recovered, assigned_for_repo, closed_pre_assignment, and closed_no_assignment.

For the reference table, we can add a summary table in the Excel tab below the chart data.

---

## Clarification on Entry Code Chart

You want a **new separate chart** showing only N50 vs N52 counts per month (excluding N53, N54, N55, etc. that might appear as entry codes). This makes sense for your correlation analysis.

---

Here are the changes:

---

## Change 8: Add N50 vs N52 chart data preparation (impound_charts_and_export.py)

**BEFORE (keep this):**
```python
    entry_code_monthly = entry_code_monthly.sort_values('first_impound_month')
```

**NEW (insert this):**
```python
    # --- N50 vs N52 Distribution by Month (for correlation analysis) ---
    df_n50_n52 = df_visual[df_visual['entry_code'].isin(['N50', 'N52'])].copy()
    n50_n52_monthly = df_n50_n52.groupby(['first_impound_month', 'entry_code']).size().unstack(fill_value=0)
    n50_n52_monthly = n50_n52_monthly.reset_index()
    n50_n52_monthly = n50_n52_monthly.sort_values('first_impound_month')
```

**AFTER (keep this):**
```python
    # --- N55 Distribution (Histogram Data) ---
```

---

## Change 9: Add n50_n52_monthly to return dictionary (impound_charts_and_export.py)

**BEFORE (keep this):**
```python
        'entry_code_monthly': entry_code_monthly,
```

**NEW (insert this):**
```python
        'n50_n52_monthly': n50_n52_monthly,
```

**AFTER (keep this):**
```python
        'n55_distribution': n55_distribution_df,
```

---

## Change 10: Create N50 vs N52 chart (impound_charts_and_export.py)

**BEFORE (keep this):**
```python
    print("Chart 4/26: Entry Code Distribution - Complete")
```

**NEW (insert this):**
```python
    # Chart 4b: N50 vs N52 Distribution
    if len(data_dict['n50_n52_monthly']) > 0:
        n50_n52_cols = [col for col in data_dict['n50_n52_monthly'].columns if col != 'first_impound_month']
        fig = create_stacked_bar_chart(
            df=data_dict['n50_n52_monthly'],
            x_col='first_impound_month',
            value_cols=n50_n52_cols,
            title='N50 vs N52 Entry Code Distribution (Prior vs New Delinquency)',
            y_label='Number of Instances',
            legend_title='Entry Code'
        )
        chart_paths['n50_n52_distribution'] = os.path.join(temp_chart_dir, 'chart_n50_n52_distribution.png')
        fig.savefig(chart_paths['n50_n52_distribution'], dpi=150, bbox_inches='tight')
        plt.close(fig)
    print("Chart 4b: N50 vs N52 Distribution - Complete")
```

**AFTER (keep this):**
```python
    # Chart 5: N55 Days Distribution Histogram
```

---

## Change 11: Add N50 vs N52 chart to Excel (impound_charts_and_export.py)

**BEFORE (keep this):**
```python
    for chart_name in ['monthly_volume', 'n55_monthly', 'outcome_distribution', 'entry_code_distribution', 'n55_histogram']:
```

**REPLACE WITH:**
```python
    for chart_name in ['monthly_volume', 'n55_monthly', 'outcome_distribution', 'entry_code_distribution', 'n50_n52_distribution', 'n55_histogram']:
```

**AFTER (keep this):**
```python
        if chart_name in chart_paths:
```

---

## Change 12: Add outcome reference table to Excel (impound_charts_and_export.py)

This change adds a reference table showing the outcome distribution counts by month.

**BEFORE (keep this):**
```python
    print("Tab 2: Volume & Distribution - Complete")
```

**FIND THIS SECTION (right before the above line):**
```python
    for chart_name in ['monthly_volume', 'n55_monthly', 'outcome_distribution', 'entry_code_distribution', 'n50_n52_distribution', 'n55_histogram']:
        if chart_name in chart_paths:
            try:
                img = Image(chart_paths[chart_name])
                img.width = 750
                img.height = 375
                ws_volume.add_image(img, f'E{row_pos}')
                row_pos += 22
            except Exception as e:
                print(f"Warning: Could not add {chart_name} chart: {e}")
    print("Tab 2: Volume & Distribution - Complete")
```

**REPLACE WITH:**
```python
    for chart_name in ['monthly_volume', 'n55_monthly', 'outcome_distribution', 'entry_code_distribution', 'n50_n52_distribution', 'n55_histogram']:
        if chart_name in chart_paths:
            try:
                img = Image(chart_paths[chart_name])
                img.width = 750
                img.height = 375
                ws_volume.add_image(img, f'E{row_pos}')
                row_pos += 22
            except Exception as e:
                print(f"Warning: Could not add {chart_name} chart: {e}")
    
    # Add Outcome Distribution Reference Table
    outcome_table_start_row = row_pos + 2
    ws_volume.cell(row=outcome_table_start_row, column=1, value="Outcome Distribution by Month (Reference Table)")
    for r_idx, row in enumerate(dataframe_to_rows(data_dict['outcome_monthly'], index=False, header=True), outcome_table_start_row + 1):
        for c_idx, value in enumerate(row, 1):
            ws_volume.cell(row=r_idx, column=c_idx, value=value)
    
    # Add N50 vs N52 Reference Table
    n50_n52_table_start_row = outcome_table_start_row + len(data_dict['outcome_monthly']) + 4
    ws_volume.cell(row=n50_n52_table_start_row, column=1, value="N50 vs N52 Distribution by Month (Reference Table)")
    for r_idx, row in enumerate(dataframe_to_rows(data_dict['n50_n52_monthly'], index=False, header=True), n50_n52_table_start_row + 1):
        for c_idx, value in enumerate(row, 1):
            ws_volume.cell(row=r_idx, column=c_idx, value=value)
    
    print("Tab 2: Volume & Distribution - Complete")
```

**AFTER (keep this):**
```python
    # --- Tab 3: Days to Milestone ---
```
